# Audit Log - MMM-My-Actual-Weather

**Date:** 2026-01-30
**Trigger:** Documentation error discovered during review (Ecowitt vs Wunderground protocol)
**Scope:** Full module quality audit including weather-aggregator backend

## Related Documentation

- [README.md](README.md) - Main module documentation
- [My-Actual-Weather-Projekt-Doku.md](My-Actual-Weather-Projekt-Doku.md) - Project documentation (German)
- [WMO_Ableitungsmoeglichkeiten.md](weather-aggregator/docs/WMO_Ableitungsmoeglichkeiten.md) - WMO code derivation

---

## Summary

| Category | Found | Fixed | Skipped |
|----------|-------|-------|---------|
| Critical | 3 | 3 | 0 |
| Medium | 5 | 5 | 0 |
| Minor | 17 | 9 | 8 |
| **Total** | **25** | **17** | **8** |

---

## Critical Issues

### 1. API Key in Source Code (SECURITY)
- **File:** `MMM-My-Actual-Weather.js:66`
- **Problem:** Wunderground API key hardcoded as default value
- **Fix:** Default set to `""`, value must come from config.js
- **Status:** FIXED

### 2. Hardcoded IP Addresses
- **File:** `MMM-My-Actual-Weather.js:62`
- **Problem:** Aggregator URL with specific IP as default
- **Fix:** Default set to `""`, value must come from config.js
- **Status:** FIXED

### 3. config.php with Local Values in Git
- **File:** `weather-aggregator/config.php`
- **Problem:** Local IPs/settings committed to repository
- **Fix:**
  - Created `config.example.php` with placeholders
  - Added `config.php` to `.gitignore`
  - Ran `git rm --cached` to untrack
- **Status:** FIXED

---

## Medium Issues

### 4. No Error Notification when All Data Sources Fail
- **File:** `node_helper.js:223-227, 295-298`
- **Problem:** If aggregator AND Wunderground fail AND no cached data exists, frontend receives no notification (stuck at "Loading")
- **Fix:** Added `WEATHER_ERROR` notification in else-branches
- **Status:** FIXED

### 5. Commented-Out Legacy Code
- **File:** `MMM-My-Actual-Weather.js:94-97`
- **Problem:** Old PWS push config commented out instead of deleted
- **Fix:** Removed (Git history preserves old code)
- **Status:** FIXED

### 6. Undocumented Debug Endpoint
- **File:** `README.md`
- **Problem:** `api.php?action=raw` endpoint not documented
- **Fix:** Added to API Endpoints table with "(Debug)" note
- **Status:** FIXED

### 7. Hardcoded Humidity Threshold for WMO 11
- **File:** `wmo_derivation.php:312`
- **Problem:** `humidity > 95` hardcoded while all other thresholds use config constants
- **Fix:** Added `SHALLOW_FOG_HUMIDITY_MIN` constant to config.php
- **Status:** FIXED

### 8. Inconsistent Sensor Names in Documentation
- **Files:** `MMM-My-Actual-Weather.js`, `README.md`
- **Problem:** JS defaults had personal names ("WoZi", "Therapie")
- **Fix:** Changed to generic "Sensor 1", "Sensor 2"
- **Status:** FIXED

---

## Minor Issues

### 9. Debug Comments in Production Code
- **File:** `MMM-My-Actual-Weather.js:24-26`
- **Problem:** "ADDED LOGGING FOR DEBUGGING" markers left in code
- **Fix:** Removed entirely
- **Status:** FIXED

### 10. Error Suppression with @ Operator
- **File:** `pws_receiver.php:130`
- **Problem:** `@file_get_contents` considered anti-pattern
- **Resolution:** Intentional - suppresses duplicate warnings, error handling is explicit
- **Fix:** Added explanatory comment
- **Status:** FIXED (documented)

### 11. Gaps in AP Numbers
- **File:** `node_helper.js` header
- **Problem:** AP numbers jump from 4 to 46
- **Resolution:** AP numbering is cross-module (other APs belong to other modules)
- **Fix:** Added comment "AP numbering is cross-module. For this reason gaps can occur!"
- **Status:** FIXED (documented)

### 12. Inconsistent Logging Methods
- **Files:** Various
- **Problem:** Frontend uses `Log.debug()`, backend uses `console.log()`, PHP uses `error_log()`
- **Resolution:** Architecture-dependent - different environments have different logging APIs
- **Status:** SKIPPED (by design)

### 13. Magic Number 300 Seconds
- **File:** `node_helper.js:154`
- **Problem:** `dataAge > 300` hardcoded for stale detection
- **Fix:** Added config parameter `staleThreshold` (default 300)
- **Status:** FIXED

### 14. Sensor Name Documentation Unclear
- **Problem:** Unclear whether config.js or config.php is primary for sensor names
- **Resolution:** Both are primary for their context (MagicMirror vs Dashboard)
- **Status:** SKIPPED (by design)

### 15. Missing Null Check for metric/imperial
- **File:** `node_helper.js:251`
- **Problem:** `obs.metric || obs.imperial` could be undefined
- **Fix:** Added null check with descriptive error
- **Status:** FIXED

### 16. Orphaned Documentation References
- **File:** `README.md`
- **Problem:** Reference to `weather-aggregator/docs/WMO_Ableitungsmoeglichkeiten.md`
- **Resolution:** File exists, reference is correct
- **Status:** SKIPPED (no issue)

### 17. Dashboard Feedback Not in README
- **File:** `README.md`
- **Problem:** Feedback tabs supposedly not documented
- **Resolution:** Already documented in Dashboard section (lines 267-268)
- **Status:** SKIPPED (already documented)

### 18. WMO 55 Comment "Undocumented"
- **File:** `node_helper.js:37`
- **Problem:** Audit flagged comment as "undocumented"
- **Resolution:** A comment IS documentation - nonsensical finding
- **Status:** SKIPPED (invalid finding)

### 19. Delta Calculation Fallback Undocumented
- **Problem:** What happens when sky_temp is null?
- **Resolution:** Falls back to Wunderground - already implemented and working
- **Status:** SKIPPED (already handled)

### 20. Stream Context Pattern Undocumented
- **File:** `pws_receiver.php`
- **Resolution:** Covered by fix for issue #10
- **Status:** FIXED (via #10)

### 21. Database Error Handling
- **File:** `pws_receiver.php:255-258`
- **Problem:** Unclear what PWS does when receiving error response
- **Fix:** Added comment explaining Ecowitt behavior (ignores errors, retries next interval)
- **Status:** FIXED

### 22. JSON Parse Error Not Logged Specifically
- **File:** `pws_receiver.php:139-143`
- **Problem:** Generic "invalid response" log for both JSON errors and missing fields
- **Fix:** Split into specific logs: "JSON parse error" and "missing sky_temp_c"
- **Status:** FIXED

### 23. CloudWatcher API Dependency
- **Problem:** WMO derivation requires CloudWatcher
- **Resolution:** By design - without CloudWatcher, Wunderground fallback is used
- **Status:** SKIPPED (by design)

### 24. Database Connection Implicit
- **File:** `pws_receiver.php:19`
- **Problem:** No check if db_connect.php exists before require
- **Fix:** Added `file_exists()` checks with descriptive error messages
- **Status:** FIXED

### 25. config.php Constants Dependency
- **Problem:** wmo_derivation.php requires constants from config.php
- **Resolution:** Not a standalone script - always included via pws_receiver.php which loads config.php first
- **Status:** SKIPPED (by design)

---

## Additional Fixes During Audit

### Documentation Corrections (discovered before formal audit)

1. **README.md:250** - PWS configuration instructions
   - Wrong: "Configure PWS to push to pws_receiver.php"
   - Fixed: Ecowitt protocol configuration (IP, Path `/data/report/`, Port 8000, Interval 60s)

2. **pws_receiver.php:5** - Header comment
   - Wrong: "Wunderground protocol"
   - Fixed: "Ecowitt protocol via pws_receiver_post.php"

3. **README.md Components table** - Added pws_receiver_post.php with explanation of POST-to-GET adapter

4. **CLAUDE.md** - Added Remote-Zugriff section for webserver (172.23.56.196)

---

## Files Modified

| File | Changes |
|------|---------|
| `MMM-My-Actual-Weather.js` | Defaults to "", removed debug code, sensor names, staleThreshold |
| `node_helper.js` | WEATHER_ERROR notification, null checks, AP comment, staleThreshold |
| `README.md` | Ecowitt config, Components table, API endpoint |
| `pws_receiver.php` | Header comment, error handling, file_exists checks, JSON logging |
| `wmo_derivation.php` | SHALLOW_FOG_HUMIDITY_MIN constant |
| `config.php` | Added SHALLOW_FOG_HUMIDITY_MIN |
| `config.example.php` | NEW - template with placeholders |
| `.gitignore` | Added weather-aggregator/config.php |
| `CLAUDE.md` | Added Remote-Zugriff section |

---

## Recommendations for Future Audits

1. **Skip "comment undocumented" findings** - comments ARE documentation
2. **Skip cross-module AP numbering gaps** - documented in header
3. **Skip environment-specific logging differences** - by design
4. **Check if issues are already documented** before flagging

---

*Audit performed with Claude Code*
